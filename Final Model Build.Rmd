## Final Model Build

We use our predictions from all of our previous models to form a final, "Model of Models." Hopefully, this contains better predictive power than any individual model. To accomplish this, we use a 70/30 split on our current test set.

```{r}
cat("First, we split our current test data in train and testsplit at 70/30\n")
final_preds <- data.frame(TARGET = test_processed$TARGET, log_pred, las_pred, knn_pred, ann_pred, dt_pred, rf_pred, svm_pred)
scores <- c()
train_split <- .70
set.seed(12345)
train_rows <- sample(1:nrow(final_preds), nrow(final_preds) * train_split)

final_train <- final_preds[train_rows,]
final_test <- final_preds[-train_rows,]

summary(final_train)
summary(final_test)

final_tree <- C5.0(as.factor(TARGET) ~ ., data = final_train, trials = 100, control = C5.0Control(minCases = 1, winnow = TRUE))
final_pred <- predict(final_tree, final_test)
final_cm <- confusionMatrix(as.factor(final_pred), as.factor(final_test$TARGET), positive = "1")
final_cm
cat("With a sensitivity of", final_cm$byClass["Sensitivity"], "and specificity of", final_cm$byClass["Specificity"], "we see fairly decent performance, but this may be improved with a cost matrix\n")
scores <- c(scores, (final_cm$byClass["Sensitivity"] * 3 + final_cm$byClass["Specificity"]))

cost_matrix <- matrix(c(0, 1, 62, 0), nrow = 2)
cost_matrix
final_tree2 <- C5.0(as.factor(TARGET) ~ ., data = final_train, costs = cost_matrix)
plot(final_tree2)
final_pred2 <- predict(final_tree2, final_test)
final_cm2 <- confusionMatrix(as.factor(final_pred2), as.factor(final_test$TARGET), positive = "1")
final_cm2
cat("With a sensitivity of", final_cm2$byClass["Sensitivity"], "and specificity of", final_cm2$byClass["Specificity"], "we see better performance from the model with \n")
scores <- c(scores, (final_cm2$byClass["Sensitivity"] * 3 + final_cm2$byClass["Specificity"]))

cms <- list(final_cm, final_cm2)
best_model_idx <- as.numeric(which.max(scores))
best_model <- get(paste0("final_tree", best_model_idx))
best_cm <- get(paste0("final_cm", best_model_idx))
cat("Final 1 is the original final model, Final 2 is the final model with a cost matrix\n")
cat("Best model: Final", best_model_idx, "with sensitivity:", cms[[best_model_idx]]$byClass["Sensitivity"], "and specificty", cms[[best_model_idx]]$byClass["Specificity"], "\n")
cm_ann <- cms[[best_model_idx]]
cm_ann
cat("Because our Final", best_model_idx, "model performs better considering our 3:1::Sens:Spec ratio, we use that model going forward\n")
```

